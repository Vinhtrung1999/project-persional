<link rel="stylesheet" href="/css/TTBDetail.css">
<h2 class="text-center" style="padding: 10px;" id="head"></h2>

<div class="block-detail f-1-2">
    <div class="block-detail-header t-center">
        <img id="img-logo" src="/images/logo-equip.png" alt="" width="100px" height="100px">
    </div>
    <div class="block-detail-body">
        <div class="body-item p-10">
            <div class="body-item-title">ID</div>
            <div class="body-item-content" id="idTTB"></div>
        </div>
        <div class="body-item p-10">
            <div class="body-item-title">Tag</div>
            <div class="body-item-content" id="name"></div>
        </div>
        <div class="body-item p-10">
            <div class="body-item-title">Quantity</div>
            <div class="body-item-content" id="qty"></div>
        </div>

        <div class="body-item p-10">
            <div class="body-item-title">Price input</div>
            <div class="body-item-content" id="priceIn"></div>
        </div>
        <div class="body-item p-10">
            <div class="body-item-title">Date</div>
            <div class="body-item-content" id="date"></div>
        </div>
    </div>
    <div class="t-center">
        <% if(locals.position === 2){ %>
            <button type="button" class="btn-custom f-1-2 m-10 bg-green cl-white" id="btn-show-modal">
                <i class="fa-solid fa-pen-to-square"></i>
            </button>
        <% } %>
        <a href="/equipment/listEquipment">
            <button class="btn-custom f-1-2 m-10">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
            </button>
        </a>
    </div>
</div>

<div class="modal" id="myModal" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-content">
      
        <!-- Modal Header -->
        <div class="modal-header">
            <div class="t-center">
                <img id="img-logo" src="/images/logo-equip.png" alt="" width="100px" height="100px">
            </div>
        </div>
        
        <!-- Modal body -->
        <div class="modal-body f-1">
            <div class="modal-body-item p-10">
                <div class="MD-body-item-title">ID</div>
                <div class="MD-body-item-content" id="idTTB_MD"></div>
            </div>
            <div class="body-item p-10">
                <div class="MD-body-item-title">Quantity damaged</div>
                <div class="MD-body-item-content">
                    <input class="input-custom f-1" type="number" name="" id="qty_MD" placeholder="enter number of damaged">
                </div>
            </div>
        </div>
    
        
        <!-- Modal footer -->
        <div class="modal-footer t-center">
            <button id="btn_update" type="button" class="btn-custom f-1 m-10 bg-green cl-white">
                <i class="fa-solid fa-pen-to-square"></i>
            </button>
            <button type="button" class="btn-custom f-1 m-10" data-dismiss="modal" id="btn-close-modal">
                X
            </button>
        </div>
        <div class="err" id="err"></div>
      </div>
    </div>
  </div>



<script>
    let url = new URL(window.location)
    let idTTB = url.searchParams.get('idTTB')    
    let btn_show_modal = document.getElementById('btn-show-modal')
    let btn_close_modal = document.getElementById('btn-close-modal')

    btn_show_modal.addEventListener('click', () => {
        document.getElementById('myModal').style.display = 'block'
    })

    btn_close_modal.addEventListener('click', () => {
        document.getElementById('myModal').style.display = 'none'
    })

    fetch('/api/equipment/getTTB/'+idTTB+"?token=<%= token %>", {
        method: "GET",
        headers: {
            'Content-Type': 'application/json'
        },
    })
    .then(req => req.json())
    .then(json => {
        if(json.code === 0){
            data = json.data[0]
            let idTTB = document.getElementById('idTTB')
            let name = document.getElementById('name')
            let qty = document.getElementById('qty')
            let priceIn = document.getElementById('priceIn')
            let date = document.getElementById('date')

            idTTB.innerHTML = data.idTTB
            name.innerHTML = data.name
            qty.innerHTML = data.qty
            priceIn.innerHTML = parseInt(data.priceIn).toLocaleString('vi', {style : 'currency', currency : 'VND'})
            date.innerHTML = data.dateIn

            document.getElementById('head').innerHTML = data.idTTB

            let idTTB_MD = document.getElementById('idTTB_MD')
            let qty_MD = document.getElementById('qty_MD')

            idTTB_MD.innerHTML = data.idTTB
            qty_MD.value = data.qty
        }  
    })
    .catch(e => console.log(e))

    let btn_update = document.getElementById('btn_update')

    btn_update.addEventListener("click", () => {
        document.getElementById('err').innerHTML = ""
        let idTTB_MD = document.getElementById('idTTB_MD').innerHTML
        let qty_MD = document.getElementById('qty_MD').value

        if(idTTB_MD && qty_MD)
        {
            fetch('/updateTTB_broken', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    token : "<%= token %>",
                    idTTB : idTTB_MD,
                    qty : qty_MD
                })
            })
            .then(res => res.json())
            .then(json => {
                if(json.code === 0)
                    return window.location.href = ""
                else
                    document.getElementById('err').innerHTML = "update fail"
            })
        }else
            document.getElementById('err').innerHTML = "please check information again"
    })

</script>