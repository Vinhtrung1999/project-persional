<h2 class="text-center" style="padding: 10px;" id="head"></h2>
<table class="table table-hover" style="width: 50%; margin: auto;">
    <tbody id="tb">
        <tr>
            <td>ID</td>
            <td id="idTTB"></td>
        </tr>
        <tr>
            <td>Name</td>
            <td id="name"></td>
        </tr>
        <tr>
            <td>Quantity</td>
            <td id="qty"></td>
        </tr>
        <tr>
            <td>Price input</td>
            <td id="priceIn"></td>
        </tr>
        <tr>
            <td>Date input</td>
            <td id="date"></td>
        </tr>
    </tbody>
</table>
<div class="text-center">
    <a href="/listTTB"><button class="btn btn-dark">Back</button></a>
    <% if(locals.position === 2){ %>
        <button type="button" class="btn btn-info" data-toggle="modal" data-target="#myModal">Update</button>
    <% } %>
</div>

<div class="modal" id="myModal">
    <div class="modal-dialog">
      <div class="modal-content">
      
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">Update</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        
        <!-- Modal body -->
        <div class="modal-body">
            <table class="table table-hover">
                <tbody id="tb">
                    <tr>
                        <td>ID</td>
                        <td id="idTTB_MD"></td>
                    </tr>
                    <tr>
                        <td>Quantity damaged</td>
                        <td><input type="number" name="" id="qty_MD"></td>
                    </tr>            
                </tbody>
            </table>
            <div class="text-center" style="color: red;" id="err"></div>
        </div>
        
        <!-- Modal footer -->
        <div class="modal-footer">
            <button id="btn_update" type="button" class="btn btn-light">Update</button>
            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        </div>
        
      </div>
    </div>
  </div>



<script>
    var url = new URL(window.location)
    var idTTB = url.searchParams.get('idTTB')    


    fetch('/getTTB/'+idTTB+"?token=<%= token %>", {
        method: "GET",
        headers: {
            'Content-Type': 'application/json'
        },
    })
    .then(req => req.json())
    .then(json => {
        console.log(json)
        if(json.code === 0){
            data = json.data[0]
            var idTTB = document.getElementById('idTTB')
            var name = document.getElementById('name')
            var qty = document.getElementById('qty')
            var priceIn = document.getElementById('priceIn')
            var date = document.getElementById('date')

            idTTB.innerHTML = data.idTTB
            name.innerHTML = data.name
            qty.innerHTML = data.qty
            priceIn.innerHTML = parseInt(data.priceIn).toLocaleString('vi', {style : 'currency', currency : 'VND'})
            date.innerHTML = data.dateIn

            document.getElementById('head').innerHTML = data.idTTB

            var idTTB_MD = document.getElementById('idTTB_MD')
            var qty_MD = document.getElementById('qty_MD')

            idTTB_MD.innerHTML = data.idTTB
            qty_MD.value = data.qty
        }  
    })
    .catch(e => console.log(e))

    var btn_update = document.getElementById('btn_update')

    btn_update.addEventListener("click", () => {
        document.getElementById('err').innerHTML = ""
        var idTTB_MD = document.getElementById('idTTB_MD').innerHTML
        var qty_MD = document.getElementById('qty_MD').value

        if(idTTB_MD && qty_MD)
        {
            fetch('/updateTTB_broken', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    token : "<%= token %>",
                    idTTB : idTTB_MD,
                    qty : qty_MD
                })
            })
            .then(res => res.json())
            .then(json => {
                if(json.code === 0)
                    return window.location.href = ""
                else
                    document.getElementById('err').innerHTML = "update fail"
            })
        }else
            document.getElementById('err').innerHTML = "please check information again"
    })

</script>